#!/usr/bin/with-contenv bashio

   #Check if files exist
if bashio::config.true 'use_own_certs'; then
   bashio::log.info "Using referenced ssl certificates..."
   CERTFILE=$(bashio::config 'certfile')
   KEYFILE=$(bashio::config 'keyfile')

   #Check if files exist
   [ ! -f /ssl/$CERTFILE ] && bashio::log.fatal "... Certificate /ssl/$CERTFILE not found" && exit 1
   [ ! -f /ssl/$KEYFILE ] && bashio::log.fatal "... Certificate /ssl/$KEYFILE not found" && exit 1

   #Sets certificates
  LINE=$(sed -n '/cert.crt/=' /defaults/default)
  sed -i "$LINE a ssl_certificate ${CERTFILE};" /defaults/default
  sed -i "$LINE d" /defaults/default

  LINE=$(sed -n '/cert.key/=' /defaults/default)
  sed -i "$LINE a ssl_certificate_key ${CERTFILE};" /defaults/default
  sed -i "$LINE d" /defaults/default

  bashio::log.info "... done" 
  rm /etc/cont-init.d/30-keygen
else
   bashio::log.info "No ssl certificates set. Auto generating ones."
fi
