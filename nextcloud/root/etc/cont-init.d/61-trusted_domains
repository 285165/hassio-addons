#!/usr/bin/with-contenv bashio

if bashio::config.has_value 'trusted_domains'; then
    bashio::log.info "Trusted domains set in the configuration. Refreshing domains."  && \
    LAUNCHER=`find / -name "occ"`
    ###################################
    # Remove previous trusted domains #
    ###################################
    bashio::log.info "... removing previously added trusted domain (except for first one created)"
    i=2
    until [ $i -gt 5 ]
    do
      $LAUNCHER -u abc:abc config:system:delete trusted_domains $i && \
      ((i=i+1))
    done

    ###########################
    # Add new trusted domains #
    ###########################
    TRUSTEDDOMAINS=$(bashio::config 'trusted_domains')
    bashio::log.info "... alignement with trusted domains list : ${TRUSTEDDOMAINS}" && \
    i=2
    for domain in $TRUSTEDDOMAINS
    do
        bashio::log.info "... adding ${domain}" && \
        $LAUNCHER -u abc:abc config:system:set trusted_domains $i --value=${domain} && \
        ((i=i+1))
    done
fi

bashio::log.info "Remaining configurated trusted domains :"
bashio::log.info `$LAUNCHER -u abc:abc config:system:get trusted_domains`
